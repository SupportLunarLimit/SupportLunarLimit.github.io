<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin — One Dollar Plan</title>
  <meta name="description" content="Admin dashboard for One Dollar Plan" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="assets/css/styles.css" />
  <style>.gate{max-width:560px;margin:40px auto;background:linear-gradient(180deg,var(--card),var(--card-2));border:1px solid var(--border);border-radius:16px;padding:18px}.gate h1{margin:0 0 8px}.hidden{display:none}</style>
</head>
<body>
  <header class="site-header">
    <div class="container">
      <div class="brand"><a href="index.html" style="text-decoration:none;color:inherit">One Dollar Plan</a></div>
      <nav class="nav" id="mobileNav">
        <a href="index.html#supporters">Supporters</a>
        <a href="index.html#donate">Donate</a>
        <a href="terms.html">Terms</a>
      </nav>
    </div>
  </header>

  <main>
    <section class="gate" id="gate">
      <h1>Admin sign-in</h1>
      <p class="micro">Enter admin passcode to access diagnostics & tools.</p>
      <label>Admin passcode
        <div style="display:flex;gap:8px;align-items:center">
          <input type="password" id="pin" placeholder="••••••" style="flex:1" />
          <button class="btn btn-ghost small" id="toggleShow" type="button">Show</button>
        </div>
      </label>
      <div style="margin-top:10px;display:flex;gap:10px">
        <button class="btn" id="enter">Enter</button>
        <button class="btn btn-ghost" id="back">Back to site</button>
      </div>
      <div id="gateMsg" class="micro" style="margin-top:10px;color:#fca5a5"></div>
    </section>

    <section class="section alt hidden" id="adminContent">
      <div class="container narrow">
        <div class="section-head">
          <h2>Diagnostics</h2>
          <div><button id="exportCsv" class="btn small admin-only-inline">Export CSV</button></div>
        </div>
        <div class="card">
          <div style="font-size:13px;line-height:1.6">
            <div><b>Firebase:</b> <span id="diagFb">loading…</span></div>
            <div><b>Auth:</b> <span id="diagAuth">loading…</span></div>
            <div><b>Realtime DB:</b> <span id="diagDb">loading…</span></div>
            <div><b>Listener:</b> <span id="diagListen">pending…</span></div>
            <div><b>Test write:</b> <button id="diagTestWrite" class="btn small btn-ghost" type="button">Run</button> <span id="diagWrite"></span></div>
            <div><b>Last error:</b> <span id="diagErr">—</span></div>
          </div>
        </div>
      </div>
    </section>

    <section id="supporters" class="section hidden">
      <div class="container">
        <div class="section-head">
          <h2>Supporters (Admin)</h2>
          <div class="tools">
            <button id="exportCsv2" class="btn small admin-only-inline">Export CSV</button>
          </div>
        </div>
        <div class="table-wrap">
          <table class="table" id="donorTable" aria-describedby="tableHelp">
            <thead>
              <tr>
                <th>#</th>
                <th>Name</th>
                <th>Amount</th>
                <th>Message</th>
                <th>Date</th>
                <th class="admin-only">Actions</th>
              </tr>
            </thead>
            <tbody id="donorTbody"></tbody>
          </table>
          <div id="tableHelp" class="micro">Admin can delete entries here. Export is available above.</div>
        </div>
      </div>
    </section>
  </main>

  <footer class="site-footer">
    <div class="container">
      <div>© <span id="year"></span> One Dollar Plan</div>
      <div class="micro">Admin dashboard</div>
    </div>
  </footer>

  <script>
    // --- SHA-256 helpers ---
    function toHex(bytes){ return Array.from(bytes).map(b=>b.toString(16).padStart(2,'0')).join(''); }
    async function sha256HexWebCrypto(str){
      const enc = new TextEncoder();
      const bytes = enc.encode(str);
      const cryptoObj = (window.crypto || window.msCrypto);
      const hash = await cryptoObj.subtle.digest('SHA-256', bytes);
      return toHex(new Uint8Array(hash));
    }
    // Minimal JS SHA-256 fallback
    function sha256HexFallback(ascii) { 
      function rightRotate(value, amount) { return (value>>>amount) | (value<<(32-amount)); }
      var mathPow = Math.pow; var maxWord = mathPow(2, 32);
      var i, j, result = '';

      var words = [], asciiBitLength = ascii.length*8;
      var hash = sha256HexFallback.h = sha256HexFallback.h || [];
      var k = sha256HexFallback.k = sha256HexFallback.k || [];
      var primeCounter = k.length;

      var isComposite = {};
      for (var candidate = 2; primeCounter < 64; candidate++) {
        if (!isComposite[candidate]) {
          for (i = 0; i < 313; i += candidate) { isComposite[i] = candidate; }
          hash[primeCounter] = (Math.sqrt(candidate)*maxWord)|0;
          k[primeCounter++] = (Math.pow(candidate, 1/3)*maxWord)|0;
        }
      }

      ascii += '\x80'; 
      while (ascii.length%64 - 56) ascii += '\x00'; 
      for (i = 0; i < ascii.length; i++) {
        j = ascii.charCodeAt(i);
        words[i>>2] |= j << ((3 - i)%4)*8;
      }
      words[words.length] = ((asciiBitLength/maxWord)|0);
      words[words.length] = (asciiBitLength)

      for (j = 0; j < words.length;) {
        var w = words.slice(j, j += 16);
        var oldHash = hash;
        hash = hash.slice(0, 8);

        for (i = 0; i < 64; i++) {
          var w15 = w[i - 15], w2 = w[i - 2];
          var a = hash[0], e = hash[4];
          var temp1 = hash[7]
            + ((e>>>6 | e<<26) ^ (e>>>11 | e<<21) ^ (e>>>25 | e<<7))
            + ((e & hash[5]) ^ (~e & hash[6]))
            + k[i]
            + (w[i] = (i < 16) ? w[i] : (w[i - 16]
                + ((w15>>>7 | w15<<25) ^ (w15>>>18 | w15<<14) ^ (w15>>>3))
                + w[i - 7]
                + ((w2>>>17 | w2<<15) ^ (w2>>>19 | w2<<13) ^ (w2>>>10)))|0
              );
          var temp2 = ((a>>>2 | a<<30) ^ (a>>>13 | a<<19) ^ (a>>>22 | a<<10))
            + ((a & hash[1]) ^ (a & hash[2]) ^ (hash[1] & hash[2]));

          hash = [(temp1 + temp2)|0].concat(hash);
          hash[4] = (hash[4] + temp1)|0;
          hash.pop();
        }

        for (i = 0; i < 8; i++) { hash[i] = (hash[i] + oldHash[i])|0; }
      }

      for (i = 0; i < 8; i++) {
        for (j = 3; j + 1; j--) {
          var b = (hash[i] >> (j * 8)) & 255;
          result += ((b < 16) ? 0 : '') + b.toString(16);
        }
      }
      return result;
    }

    async function sha256Hex(str){
      try{
        const cryptoObj = (window.crypto || window.msCrypto);
        if (cryptoObj && cryptoObj.subtle){
          return await sha256HexWebCrypto(str);
        }
      }catch(_){}
      return sha256HexFallback(str);
    }

    (function(){
      const gate = document.getElementById('gate');
      const adminContent = document.getElementById('adminContent');
      const supporters = document.getElementById('supporters');
      const msg = document.getElementById('gateMsg');
      const btnEnter = document.getElementById('enter');
      const btnBack = document.getElementById('back');
      const inputEl = document.getElementById('pin');
      const toggleShow = document.getElementById('toggleShow');
      const y = document.getElementById('year'); if (y) y.textContent = new Date().getFullYear().toString();

      toggleShow?.addEventListener('click', ()=>{
        const isPw = inputEl.type === 'password';
        inputEl.type = isPw ? 'text' : 'password';
        toggleShow.textContent = isPw ? 'Hide' : 'Show';
      });

      btnBack.addEventListener('click', ()=> location.href = 'index.html');

      function constantTimeEqual(a, b) {
        if (a.length !== b.length) return false;
        let r = 0; for (let i = 0; i < a.length; i++) r |= a.charCodeAt(i) ^ b.charCodeAt(i);
        return r === 0;
      }

      btnEnter.addEventListener('click', async ()=>{
        try{
          const cfg = window.DONATION_APP_CONFIG || {};
          const aa = cfg.adminAuth || {};
          if (aa.method !== 'sha256' || aa.encoding !== 'hex') throw new Error('Admin auth not configured');

          const pass = (inputEl.value || '').trim();
          if (!pass || (aa.minLength && pass.length < aa.minLength)) {
            msg.textContent = `Enter a passcode of at least ${aa.minLength || 1} characters.`;
            return;
          }

          const calc = await sha256Hex(pass);
          const ok = constantTimeEqual(calc, aa.hash);
          if (!ok){
            console.warn('[Admin Gate] Hash mismatch. calc=%s expected=%s', calc, aa.hash);
            msg.textContent = 'Incorrect passcode';
            return;
          }

          document.body.classList.add('admin-mode');
          gate.classList.add('hidden');
          adminContent.classList.remove('hidden');
          supporters.classList.remove('hidden');

          document.dispatchEvent(new Event('firebase-ready'));
          document.dispatchEvent(new Event('firebase-auth-ready'));
        }catch(e){
          msg.textContent = 'Error: ' + (e?.message || e);
        }
      });
    })();
  </script>

  <script src="assets/js/firebase-config.js?v=4"></script>
  <script type="module" src="assets/js/firebase-app.js?v=4"></script>
  <script src="assets/js/main.js?v=4"></script>
</body>
</html>
